# 库存与生产管理系统

一个基于 Django 的企业级管理系统，用于管理材料和产品的生产、采购、库存等业务流程。

## 已实现功能

### 1. 生产管理
- 生产订单管理
  - 状态流转：草稿 -> 已确认 -> 备料完成 -> 生产中 -> 已完成
  - 优先级设置（高、中、低）
  - 计划日期和实际日期记录
  - 生产单打印（支持自定义模板）
- 生产进度管理
  - 累计进度记录（支持多次录入，自动累加）
  - 进度撤销功能（支持按时间顺序撤销）
  - 实时进度百分比计算
  - 完成数量追踪
- 生产完成管理
  - 完成状态确认
  - 自动生成产品入库记录
  - 支持完成状态撤销
  - 自动更新产品库存

### 2. 库存管理
- 材料批次管理
  - 批次自动生成
  - 批次库存追踪
  - 批次使用记录
  - 批次关联采购单
- 产品库存管理
  - 自动更新库存数量
  - 库存变动记录追踪
  - 支持入库和出库操作
  - 变动历史查询
  - 事务性库存更新
  - 库存变动防重复处理
  - 库存不足自动预警

### 3. 采购管理
- 采购单处理
  - 状态管理：草稿 -> 待入库 -> 已入库 -> 已完成
  - 入库自动生成批次
  - 入库撤销功能（含批次使用检查）
  - 库存自动更新
- 采购单打印
  - 自定义模板支持
  - 材料名称和规格分列显示
  - 供应商信息展示
  - 打印预览功能

### 4. 订单管理 ✨ 新增功能
- 客户管理
  - 客户信息维护
  - 客户状态管理
  - 客户联系方式记录
- 订单管理
  - 订单创建和编辑
  - 订单状态流转：待处理 -> 生产中 -> 已完成 -> 已发货 -> 已取消
  - 订单明细管理（产品、数量、颜色、材料等）
  - 订单查询和筛选
  - 订单详情查看
- 前端界面优化
  - 响应式表格布局
  - 自适应列宽设计
  - 横向滚动支持
  - 居中对齐显示
  - 下拉选择优化

### 5. 打印功能
- 生产单打印
  - 公司抬头定制
  - 材料需求清单
  - 签名栏设置
  - 支持预览和打印
- 采购单打印
  - 供应商信息
  - 材料清单
  - 价格和总计
  - 签名和日期

### 6. 生产排程
- 工序管理
  - 8个固定工序
  - 工序产能设置
  - 瓶颈工序标识
  - 工序顺序控制
- 排程功能
  - 自动生成工序排程
  - 工序间依赖关系管理
  - 设备分配和调度
  - 操作员安排
  - 甘特图显示
  - 工序进度跟踪
  - 产能预警
- 产能报表
  - 产能使用率统计
  - 工序负荷分析
  - 瓶颈工序监控
  - 支持日期筛选
- 设备管理
  - 设备基本信息维护
  - 设备状态跟踪（正常/维护中/故障/报废）
  - 设备产能记录
  - 设备维护计划
  - 设备使用记录

### 7. 工序特点详细说明
- 工序配置
  - 工序名称和编码管理
  - 日产能设置
  - 瓶颈工序标识
  - 工序顺序维护
  - 备注信息

- 工序排程
  - 自动计算各工序时间
  - 基于产能的工时计算
  - 工序间衔接管理
  - 实际进度跟踪
  - 延迟预警机制

- 设备管理
  - 设备与工序关联
  - 设备状态实时更新
  - 设备维护计划
  - 设备产能统计
  - 设备使用记录

### 8. 最新修复和优化
- 修复了生产订单完成时产品库存重复增加的问题
- 修复了打印功能中的参数不匹配问题
- 优化了材料消耗逻辑，确保生产开始时正确扣减材料库存
- 改进了采购单打印模板，区分材料名称和规格显示
- 优化了信号处理机制，避免重复操作
- 增强了数据一致性检查，防止库存数据错误
- 生产单管理界面新增客户订单号显示，便于关联销售订单
- 添加销售订单唯一性验证，防止同一销售订单重复创建生产单

### 9. 最新功能详细说明



#### 生产单关联销售订单优化
- 在生产单列表页面显示客户订单号
- 支持按客户订单号搜索生产单
- 支持按客户订单号排序
- 提高了销售订单与生产单的关联性
- 便于客户查询订单生产状态

#### 防止重复创建生产单
- 添加销售订单唯一性验证
- 同一销售订单只能关联一个生产单
- 在创建生产单时自动检查销售订单是否已被使用
- 防止因重复创建导致的生产混乱和资源浪费
- 提高了数据一致性和业务流程规范性

### 10. 数据导入导出功能
- 支持Excel格式批量导入产品信息
- 支持Excel格式批量导入材料信息
- 支持生产计划批量导入
- 支持库存数据导出
- 支持生产数据导出分析

## 技术特性
- 基于 Django Admin 的管理界面
- 完整的数据验证和错误处理
- 事务支持，确保数据一致性
- 模板化的打印功能
- RESTful API 接口支持
- 支持多用户权限管理
- 操作日志记录追踪
- 自动化的工序排程
- 实时的产能监控
- 设备管理集成
- 信号处理机制实现业务逻辑解耦
- 缓存机制提高性能
- 数据库索引优化

## 项目结构
```
iceskate_system/
├── inventory/
│   ├── migrations/
│   ├── templates/
│   │   └── admin/
│   │       └── inventory/
│   │           └── product/
│   │               └── import_products.html
│   │
│   ├── __init__.py
│   ├── admin.py
│   ├── apps.py
│   ├── models.py
│   ├── serializers.py
│   └── signals.py
│
├── production/
│   ├── migrations/
│   ├── templates/
│   │   └── admin/
│   │       └── production/
│   │           ├── processschedule/
│   │           │   └── schedule_view.html
│   │           └── productionorder/
│   │               ├── cancel_completion.html
│   │               ├── complete_production.html
│   │               ├── print_production_order.html
│   │               └── update_progress.html
│   ├── __init__.py
│   ├── admin.py
│   ├── apps.py
│   ├── models.py
│   ├── serializers.py
│   ├── urls.py
│   ├── views.py
│   └── signals.py
│
├── manage.py
├── requirements.txt
└── iceskate_backend/
    ├── __init__.py
    ├── settings.py
    ├── urls.py
    └── wsgi.py
```

## 使用说明

### 生产流程
1. 创建生产订单
   - 填写基本信息（产品、数量、日期等）
   - 设置优先级
2. 确认订单并准备材料
   - 系统自动检查库存
   - 生成材料需求清单
3. 开始生产
   - 自动扣减材料库存
   - 生成材料出库记录
4. 记录生产进度
   - 支持多次录入进度
   - 自动累计完成数量
   - 可以撤销错误记录
5. 完成生产
   - 自动生成产品入库记录
   - 自动更新产品库存
   - 记录实际完成日期

### 注意事项
- 生产进度支持累计记录，多次录入会自动累加
- 进度记录支持撤销，但必须按时间顺序逆向撤销
- 生产完成后会自动更新产品库存
- 完成状态可以撤销，会自动扣减产品库存
- 采购入库后如果批次已用于生产，将无法撤销
- 所有库存变动都有详细的追踪记录
- 打印模板支持自定义
- 建议定期备份数据库
- 重要操作需要二次确认
- 库存变动采用事务处理，确保数据一致性
- 防止重复处理同一库存变动记录
- 库存不足时会阻止出库操作

### 工序特点
1. 激光下料
   - 基础产能：2000片/台/天
   - 设备：2台固定 + 2台可外发
   - 总产能：4000-8000片/天

2. 热处理
   - 产能：8000片/天
   - 特殊要求：夜班生产

3. 粗磨
   - 产能：6000片/天

4. 校平
   - 产能：6000片/天

5. 数控打磨刃面
   - 产能：6000片/天

6. 开刃（瓶颈工序）
   - 产能：2400片/天（3台×800片）

7. 精磨
   - 产能：5000片/天

8. 包装
   - 产能：3600片/天

### 排程规则
- 工序必须按固定顺序执行
- 后道工序依赖前道工序完成
- 支持同规格产品批次合并
- 计划单位：按周排程
- 计划稳定性：除特殊情况外不日常调整
- 优先级分为：高、中、低三级
- 设备维护时间：每月1天
- 标准工作时间：10小时/天
- 可选加班时间：+2小时/天

### 报表功能
- 产能日报
- 产能周报
- 产能月报
- 支持数据导出
- 产能预警提示
- 工序负荷分析

## 待开发功能

### 1. 采购管理
- 供应商管理
- 采购订单管理
- 采购价格管理
- 供应商评价
- 采购统计分析

### 2. 质量管理
- 质检记录
- 不良品管理
- 质量追溯
- 质量报表
- 质量控制点设置
- 质量问题分类与处理

### 3. 成本管理
- 材料成本核算
- 人工成本分配
- 制造费用分摊
- 成本报表

### 4. 移动端支持
- 生产进度录入
- 库存查询
- 条码扫描
- 移动审批

### 5. 数据分析
- 生产效率分析
- 材料消耗分析
- 产能利用率分析
- 交期达成率分析

## 最近更新
- **2025-01-15: 重大前后端集成问题修复** 🔧
  - 修复了订单模块前后端API连接问题
  - 解决了订单详情页面显示"No Data"的问题
  - 优化了前端表单布局和用户体验
  - 改进了数据处理逻辑的健壮性
- 2024-05-20: 添加了数据导入导出功能，支持Excel格式批量操作
- 2024-05-10: 优化了系统性能，提高了大数据量处理能力
- 2024-04-25: 增强了报表功能，新增材料消耗统计和生产效率分析
- 2024-04-15: 改进了用户界面，提升了操作体验
- 2024-04-01: 新增了质量控制点设置功能
- 2023-11-15: 修复了生产订单完成时产品库存重复增加的问题
- 2023-11-10: 修复了打印功能中的参数不匹配问题
- 2023-11-05: 优化了采购单打印模板，区分材料名称和规格显示
- 2023-10-30: 增强了数据一致性检查，防止库存数据错误
- 2023-10-25: 优化了信号处理机制，避免重复操作

## 📋 2025-01-15 问题排查与解决记录

### 遇到的问题

#### 1. 订单表单字段无法正常输入
**问题描述：**
- 用户反馈在订单表单中，数量、颜色、材料等字段无法正常点击和输入
- 需要手动调整边距才能看到有效信息
- 表格布局显示不正常

**问题原因：**
- 表格内表单项的CSS样式问题
- 缺少必要的宽度设置
- 表格列宽设置不合理

**解决方案：**
```css
.table-form-item {
  margin-bottom: 0 !important;
}

.table-form-item .el-form-item__content {
  width: 100%;
}
```
- 为颜色、材料、单位、备注字段的 `el-input` 组件添加 `style="width: 100%;"`
- 使用 `min-width` 替代固定 `width`，实现自适应布局
- 添加 `table-layout="fixed"` 和 `:fit="true"` 属性优化表格布局
- 启用横向滚动：`.items-card :deep(.el-card__body) { overflow-x: auto; }`

#### 2. 订单无法保存 - 前后端字段不匹配
**问题描述：**
- 新建订单时点击保存按钮无响应
- 前端提交数据但后端无法正确处理
- 后端数据库中没有新增订单记录

**问题原因：**
- 后端 `OrderSerializer` 中 `items` 字段设置为 `read_only=True`
- 无法接受创建订单时的明细数据
- 缺少嵌套创建订单及其明细的逻辑

**解决方案：**
1. **修改后端序列化器：**
```python
class OrderItemCreateSerializer(serializers.ModelSerializer):
    """用于创建订单明细的序列化器"""
    class Meta:
        model = OrderItem
        fields = ['product', 'color', 'material', 'quantity', 'unit', 'notes']

class OrderSerializer(serializers.ModelSerializer):
    items = OrderItemSerializer(many=True, read_only=True)
    items_data = OrderItemCreateSerializer(many=True, write_only=True, required=False)
    
    def create(self, validated_data):
        items_data = validated_data.pop('items_data', [])
        validated_data['order_number'] = self.generate_order_number()
        
        with transaction.atomic():
            order = Order.objects.create(**validated_data)
            for item_data in items_data:
                OrderItem.objects.create(order=order, **item_data)
        return order
```

2. **添加自动订单号生成：**
```python
def generate_order_number(self):
    today = datetime.date.today()
    date_str = today.strftime('%Y%m%d')
    latest_order = Order.objects.filter(
        order_number__startswith=f'SO{date_str}'
    ).order_by('-order_number').first()
    
    if latest_order:
        sequence = int(latest_order.order_number[-3:]) + 1
    else:
        sequence = 1
    
    return f'SO{date_str}{sequence:03d}'
```

#### 3. 订单详情页面显示"No Data"
**问题描述：**
- 订单列表可以正常显示数据
- 点击查看订单详情时页面显示空白或"No Data"
- API返回数据但前端无法正确解析

**问题原因：**
- 前端期望API返回数据在 `res.data` 中，但实际数据结构不同
- 缺少对不同API响应格式的兼容处理
- 数据处理逻辑不够健壮

**解决方案：**
```javascript
const fetchOrderDetail = async () => {
  try {
    const res = await getOrderDetail(orderId)
    
    if (res) {
      let data = null
      
      // 处理不同的响应格式
      if (res.data) {
        data = res.data
      } else if (typeof res === 'object' && (res as any).id) {
        data = res
      } else {
        console.warn('未知的订单详情数据格式:', res)
        ElMessage.error('订单数据格式错误')
        return
      }
      
      Object.assign(orderDetail, data)
      await fetchProductionOrders()
    }
  } catch (error) {
    console.error('获取订单详情失败:', error)
    ElMessage.error('获取订单详情失败')
  }
}
```

#### 4. 前端UI布局优化需求
**问题描述：**
- 表格内容不够居中美观
- 颜色和材料字段需要改为下拉选择
- 缺少合适的默认选项

**解决方案：**
1. **改进表格布局：**
```javascript
<el-table 
  :data="form.items" 
  border 
  :fit="true" 
  table-layout="fixed"
  style="width: 100%;"
>
```

2. **添加下拉选择：**
```javascript
// 颜色字段
<el-select v-model="scope.row.color" placeholder="颜色" clearable>
  <el-option label="本色" value="本色" />
</el-select>

// 材料字段 - 从后端动态加载
<el-select v-model="scope.row.material" placeholder="材料" filterable clearable>
  <el-option 
    v-for="material in materialOptions" 
    :key="material.id"
    :label="material.name" 
    :value="material.name"
  />
</el-select>
```

3. **居中对齐：**
```css
:deep(.el-table th),
:deep(.el-table td) {
  text-align: center;
}
```

### 技术改进

#### 1. 数据处理健壮性提升
- 添加了多种API响应格式的兼容处理
- 增强了错误处理和用户提示
- 添加了详细的调试日志

#### 2. 前端表单优化
- 实现了自适应表格布局
- 添加了横向滚动支持
- 优化了用户交互体验

#### 3. 后端API完善
- 实现了嵌套序列化器的创建和更新
- 添加了事务处理确保数据一致性
- 完善了订单号自动生成逻辑

### 测试验证

#### 创建了专门的API测试页面 `test_api_connection.html`
- 测试订单列表API
- 测试客户列表API  
- 测试创建订单API
- 测试订单详情API

#### 验证步骤：
1. 启动后端服务器：`python manage.py runserver 8000`
2. 启动前端服务器：`npm run dev`
3. 使用测试页面验证API连接
4. 在前端应用中测试完整流程

### 经验总结

#### 1. 前后端集成注意事项
- 确保API响应格式的一致性
- 前端需要兼容处理不同的数据结构
- 添加充分的错误处理和用户提示

#### 2. 表单布局最佳实践
- 使用 `min-width` 而非固定 `width`
- 启用表格的 `table-layout="fixed"` 属性
- 为复杂表格添加横向滚动支持

#### 3. 调试技巧
- 添加详细的console.log调试信息
- 创建专门的API测试页面
- 使用浏览器开发者工具监控网络请求

#### 4. 代码质量改进
- 使用事务处理确保数据一致性
- 添加数据验证和错误处理
- 保持代码的可读性和可维护性

### 后续优化建议

1. **性能优化**
   - 实现API响应缓存
   - 优化大数据量的表格渲染
   - 添加分页加载功能

2. **用户体验提升**
   - 添加加载状态指示器
   - 实现表单数据的自动保存
   - 优化移动端适配

3. **功能扩展**
   - 添加订单导出功能
   - 实现订单批量操作
   - 增加订单状态变更的审批流程

## 联系方式
如有问题或建议，请联系系统管理员。
- 技术支持邮箱: support@iceskate-system.com
- 问题反馈电话: 400-123-4567
- 工作时间: 周一至周五 9:00-18:00

## 系统优化
- 性能优化
  - 数据库查询优化
  - 缓存机制实现
  - 大数据量处理优化
- 用户界面优化
  - 响应式设计
  - 操作流程简化
  - 用户体验改进
- 移动端适配
  - 移动端界面优化
  - 触控操作支持
  - 移动端专用功能
- 数据备份恢复
  - 自动备份机制
  - 增量备份支持
  - 一键恢复功能
- 系统监控告警
  - 性能监控
  - 异常操作监控
  - 关键指标告警

## 系统要求
- Python 3.8+
- Django 3.2+
- PostgreSQL/MySQL
- Redis (用于缓存)
- Nginx (生产环境)
- 最低配置服务器: 4核8G内存
- 推荐配置服务器: 8核16G内存
- 存储空间: 至少100GB

## 安装部署
1. 克隆代码库
   ```
   git clone https://github.com/your-org/iceskate_system.git
   cd iceskate_system
   ```
2. 安装依赖
   ```
   pip install -r requirements.txt
   ```
3. 配置数据库
   - 创建数据库: `CREATE DATABASE iceskate_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;`
   - 配置数据库连接: 修改 `iceskate_backend/settings.py` 中的数据库配置
4. 执行迁移
   ```
   python manage.py migrate
   ```
5. 创建超级用户
   ```
   python manage.py createsuperuser
   ```
6. 运行服务器
   ```
   python manage.py runserver 0.0.0.0:8000
   ```
7. 配置 Redis 缓存（可选）
   - 安装Redis服务
   - 修改 `iceskate_backend/settings.py` 中的缓存配置
8. 配置 Nginx（生产环境）
   - 安装Nginx
   - 配置反向代理
   - 配置静态文件服务

## 开发指南
- 代码规范
  - 遵循PEP 8编码规范
  - 使用类型注解
  - 编写详细的文档字符串
  - 代码提交前进行lint检查
- API 文档
  - RESTful API设计原则
  - API版本控制
  - 认证与授权
  - 错误处理
- 单元测试说明
  - 使用Django测试框架
  - 测试覆盖率要求
  - 测试数据准备
  - 测试运行方法
- 贡献指南
  - 分支管理策略
  - 提交信息规范
  - 代码审查流程
  - 合并请求处理

## 常见问题

### 数据库备份恢复
1. **如何备份数据库?**
   - 使用管理界面的"系统管理">"数据备份"功能
   - 或使用命令行: `python manage.py dbbackup`
   - 自动备份设置在系统设置中配置

2. **如何恢复数据库?**
   - 使用管理界面的"系统管理">"数据恢复"功能
   - 选择备份文件并确认恢复
   - 恢复前系统会自动创建当前状态的备份

3. **备份文件存储在哪里?**
   - 默认存储在服务器的 `/var/backups/iceskate_system/` 目录
   - 可在系统设置中修改备份路径
   - 建议配置远程备份或云存储备份

### 性能优化建议
1. **系统响应缓慢怎么办?**
   - 检查数据库索引是否合理
   - 配置Redis缓存减轻数据库负担
   - 优化大数据量查询的SQL语句
   - 考虑增加服务器资源

2. **如何优化大批量数据导入?**
   - 使用批量导入功能而非单条添加
   - 导入前暂时禁用不必要的触发器
   - 大批量导入建议在非高峰期进行
   - 导入前备份数据库

3. **报表生成慢怎么处理?**
   - 使用缓存机制存储报表结果
   - 配置报表预生成任务
   - 优化报表查询SQL
   - 考虑使用专门的报表服务

### 故障排除指南
1. **生产订单状态无法更新**
   - 检查是否有未完成的前置工序
   - 验证用户权限是否正确
   - 查看系统日志中的错误信息
   - 联系技术支持提供详细错误截图

2. **库存数据不一致**
   - 运行"库存数据一致性检查"工具
   - 查看库存变动历史记录
   - 暂停相关业务操作
   - 必要时使用最近的备份恢复

3. **打印功能异常**
   - 检查打印模板是否正确
   - 验证打印数据是否完整
   - 更新浏览器到最新版本
   - 尝试使用PDF导出功能替代

4. **用户无法登录**
   - 检查用户名和密码是否正确
   - 验证用户账号是否被禁用
   - 清除浏览器缓存和Cookie
   - 联系管理员重置密码

## 许可证
MIT License

版权所有 (c) 2024 冰刀系统

特此免费授予任何获得本软件副本和相关文档文件（"软件"）的人不受限制地处理本软件的权利，
包括不限于使用、复制、修改、合并、发布、分发、再许可和/或出售本软件副本，
以及允许本软件的使用者这样做，但须符合以下条件：

上述版权声明和本许可声明应包含在本软件的所有副本或实质性部分中。

本软件按"原样"提供，不提供任何形式的明示或暗示的保证，包括但不限于对适销性、特定用途的适用性和非侵权性的保证。
在任何情况下，作者或版权持有人均不对任何索赔、损害或其他责任负责，无论是在合同诉讼、侵权行为或其他方面，
由软件或软件的使用或其他交易引起、产生或与之相关。 