<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API连接测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .result { margin-top: 10px; padding: 10px; background: #f5f5f5; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>冰刀系统 API 连接测试</h1>
    
    <div class="test-section">
        <h3>1. 测试订单列表 API</h3>
        <button onclick="testOrderList()">测试订单列表</button>
        <div id="orderResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>2. 测试客户列表 API</h3>
        <button onclick="testCustomerList()">测试客户列表</button>
        <div id="customerResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>3. 测试创建订单 API</h3>
        <button onclick="testCreateOrder()">测试创建订单</button>
        <div id="createResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>4. 测试订单详情 API</h3>
        <input type="number" id="orderIdInput" placeholder="输入订单ID" value="1" style="margin-right: 10px;">
        <button onclick="testOrderDetail()">测试订单详情</button>
        <div id="detailResult" class="result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        
        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                return { success: true, data };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }
        
        async function testOrderList() {
            const resultDiv = document.getElementById('orderResult');
            resultDiv.innerHTML = '正在测试...';
            
            const result = await apiCall(`${API_BASE}/orders/orders/`);
            
            if (result.success) {
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <strong>成功!</strong><br>
                    数据类型: ${typeof result.data}<br>
                    ${Array.isArray(result.data) ? 
                        `数组长度: ${result.data.length}` : 
                        `包含字段: ${Object.keys(result.data).join(', ')}`
                    }<br>
                    <details>
                        <summary>查看原始数据</summary>
                        <pre>${JSON.stringify(result.data, null, 2)}</pre>
                    </details>
                `;
            } else {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<strong>失败:</strong> ${result.error}`;
            }
        }
        
        async function testCustomerList() {
            const resultDiv = document.getElementById('customerResult');
            resultDiv.innerHTML = '正在测试...';
            
            const result = await apiCall(`${API_BASE}/orders/customers/`);
            
            if (result.success) {
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <strong>成功!</strong><br>
                    数据类型: ${typeof result.data}<br>
                    ${Array.isArray(result.data) ? 
                        `数组长度: ${result.data.length}` : 
                        `包含字段: ${Object.keys(result.data).join(', ')}`
                    }<br>
                    <details>
                        <summary>查看原始数据</summary>
                        <pre>${JSON.stringify(result.data, null, 2)}</pre>
                    </details>
                `;
            } else {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<strong>失败:</strong> ${result.error}`;
            }
        }
        
        async function testCreateOrder() {
            const resultDiv = document.getElementById('createResult');
            resultDiv.innerHTML = '正在测试...';
            
            const testData = {
                customer: 1,
                order_date: '2025-01-15',
                delivery_date: '2025-01-22',
                status: 'pending',
                notes: '测试订单',
                customer_order_number: 'TEST' + Date.now(),
                items: [
                    {
                        product: 1,
                        color: '本色',
                        material: '铝合金',
                        quantity: 10,
                        unit: '个',
                        notes: '测试备注'
                    }
                ]
            };
            
            const result = await apiCall(`${API_BASE}/orders/orders/`, {
                method: 'POST',
                body: JSON.stringify(testData)
            });
            
            if (result.success) {
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <strong>创建成功!</strong><br>
                    订单ID: ${result.data.id || 'N/A'}<br>
                    订单号: ${result.data.order_number || 'N/A'}<br>
                    <details>
                        <summary>查看返回数据</summary>
                        <pre>${JSON.stringify(result.data, null, 2)}</pre>
                    </details>
                `;
            } else {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<strong>创建失败:</strong> ${result.error}`;
            }
        }
        
        async function testOrderDetail() {
            const resultDiv = document.getElementById('detailResult');
            const orderId = document.getElementById('orderIdInput').value;
            
            if (!orderId) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = '<strong>请输入订单ID</strong>';
                return;
            }
            
            resultDiv.innerHTML = '正在测试...';
            
            const result = await apiCall(`${API_BASE}/orders/orders/${orderId}/`);
            
            if (result.success) {
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <strong>成功!</strong><br>
                    订单ID: ${result.data.id || 'N/A'}<br>
                    订单号: ${result.data.order_number || 'N/A'}<br>
                    客户: ${result.data.customer_name || 'N/A'}<br>
                    明细数量: ${result.data.items ? result.data.items.length : 0}<br>
                    数据类型: ${typeof result.data}<br>
                    <details>
                        <summary>查看完整数据</summary>
                        <pre>${JSON.stringify(result.data, null, 2)}</pre>
                    </details>
                `;
            } else {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<strong>失败:</strong> ${result.error}`;
            }
        }
    </script>
</body>
</html> 