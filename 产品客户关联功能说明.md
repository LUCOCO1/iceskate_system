# 产品客户关联功能说明

## 功能概述
已成功为库存管理的产品界面添加了客户信息功能，实现了产品与客户的多对多关联关系。用户可以通过点击选择的方式为产品关联多个客户，也可以按客户筛选产品。

## 实现内容

### 1. 后端模型修改 (`inventory/models.py`)
- 在 `Product` 模型中添加了 `customers` 字段，使用 `ManyToManyField` 与 `orders.Customer` 模型建立多对多关系
- 字段配置：
  ```python
  customers = models.ManyToManyField(
      'orders.Customer',
      blank=True,
      verbose_name='关联客户',
      help_text='选择该产品关联的客户'
  )
  ```

### 2. 后端管理界面优化 (`inventory/admin.py`)
- 更新了 `ProductAdmin` 类，添加了客户信息的显示和管理功能
- **列表显示**：
  - 添加了 `get_customers_display` 方法，在产品列表中显示关联的客户
  - 最多显示3个客户名称，超过时显示"等X个客户"
  - 添加了按客户的过滤功能

- **编辑界面**：
  - 使用 `filter_horizontal` 实现美观的多选客户界面
  - 将表单分组为：基本信息、库存信息、客户关联、其他
  - 添加了字段说明，提高用户体验

#### 关键功能代码：
```python
def get_customers_display(self, obj):
    """显示关联的客户"""
    customers = obj.customers.all()
    if customers.exists():
        customer_names = [customer.name for customer in customers[:3]]
        display_text = ', '.join(customer_names)
        if customers.count() > 3:
            display_text += f' 等{customers.count()}个客户'
        return display_text
    return '暂无关联客户'
```

### 3. API接口扩展 (`inventory/views.py` & `inventory/serializers.py`)
- **ProductViewSet** 添加了客户筛选功能：
  ```python
  def get_queryset(self):
      queryset = super().get_queryset()
      customer_id = self.request.query_params.get('customer', None)
      if customer_id:
          queryset = queryset.filter(customers=customer_id)
      return queryset
  ```

- 添加了 `customers` 动作，用于获取客户列表：
  ```python
  @action(detail=False, methods=['get'])
  def customers(self, request):
      customers = Customer.objects.filter(is_active=True)
      serializer = CustomerSerializer(customers, many=True)
      return Response(serializer.data)
  ```

- **ProductSerializer** 增强：
  - 添加了 `customer_names` 字段：返回客户名称数组
  - 添加了 `customers_display` 字段：返回客户显示字符串
  - 支持客户信息的序列化和反序列化

### 4. 前端界面改进 (`frontend/src/views/inventory/ProductList.vue`)

#### 搜索功能增强：
- 添加了客户筛选下拉框
- 支持按客户过滤产品列表
- 客户选择支持搜索和清除功能

#### 表格显示优化：
- 新增"关联客户"列，显示产品关联的客户信息
- 使用标签(Tag)样式美化显示效果
- 当无关联客户时显示灰色提示文字

#### 编辑表单改进：
- **布局优化**：使用两列布局，提高空间利用率
- **客户选择**：
  - 支持多选客户功能
  - 下拉选项显示客户名称和编码
  - 支持搜索筛选客户
  - 可清除已选择的客户

- **表单验证**：保持原有验证规则，确保数据完整性

#### 关键前端代码：
```vue
<!-- 客户筛选 -->
<el-select
  v-model="searchForm.customer"
  placeholder="选择客户筛选"
  clearable
  filterable
>
  <el-option
    v-for="customer in customerOptions"
    :key="customer.id"
    :label="customer.name"
    :value="customer.id"
  />
</el-select>

<!-- 客户多选 -->
<el-select
  v-model="productForm.customers"
  multiple
  filterable
  placeholder="选择关联的客户（可多选）"
>
  <el-option
    v-for="customer in customerOptions"
    :key="customer.id"
    :label="customer.name"
    :value="customer.id"
  >
    <span style="float: left">{{ customer.name }}</span>
    <span style="float: right; color: #8492a6; font-size: 13px">{{ customer.code }}</span>
  </el-option>
</el-select>
```

### 5. API接口更新 (`frontend/src/api/inventory.ts`)
- 更新了客户列表获取接口，指向正确的端点：
  ```typescript
  export function getCustomerList(params?: any) {
    return request({
      url: '/inventory/products/customers/',
      method: 'get',
      params
    })
  }
  ```

### 6. 数据库迁移
- 创建并应用了数据库迁移文件：`0006_product_customers.py`
- 添加了产品和客户之间的多对多关系表

## 功能特点

### 🎯 核心功能
1. **多对多关联**：一个产品可以关联多个客户，一个客户也可以关联多个产品
2. **智能筛选**：支持按客户筛选产品，快速找到特定客户的产品
3. **直观显示**：在产品列表中直接显示关联的客户信息
4. **便捷编辑**：通过下拉多选框轻松管理产品与客户的关联关系

### 🎨 用户体验优化
1. **美观界面**：使用 Element Plus 的现代化组件
2. **搜索支持**：客户选择支持搜索功能，快速定位
3. **清晰反馈**：无关联客户时有明确提示
4. **响应式布局**：表单采用两列布局，充分利用空间

### 🔧 技术特性
1. **数据完整性**：通过外键约束保证数据关系的完整性
2. **性能优化**：使用预取和优化查询减少数据库访问
3. **错误处理**：完善的错误处理和用户提示
4. **兼容性**：保持与现有功能的完全兼容

## 使用方法

### 在管理后台操作：
1. 进入"库存管理" → "产品"
2. 新增或编辑产品时，在"客户关联"部分选择相关客户
3. 使用水平筛选器（filter_horizontal）进行多选操作
4. 在产品列表中查看"关联客户"列

### 在前端界面操作：
1. **查看产品**：在产品列表的"关联客户"列查看产品关联的客户
2. **筛选产品**：使用客户筛选下拉框按特定客户筛选产品
3. **编辑关联**：在产品编辑对话框中使用多选下拉框管理客户关联
4. **搜索客户**：在客户选择框中输入关键词快速搜索客户

### API调用示例：
```javascript
// 获取客户列表
const customers = await getCustomerList()

// 按客户筛选产品
const products = await getProductList({ customer: customerId })

// 创建带客户关联的产品
await createProduct({
  name: '产品名称',
  code: '产品编码',
  customers: [1, 2, 3] // 客户ID数组
})
```

## 数据流程

1. **获取数据**：页面加载时同时获取产品列表和客户列表
2. **显示关联**：产品列表显示每个产品关联的客户信息
3. **筛选功能**：用户选择客户后，重新请求产品列表（带客户参数）
4. **编辑保存**：提交表单时，客户ID数组一并提交到后端
5. **关系维护**：Django自动维护多对多关系表

## 优势总结

- **业务价值**：帮助企业更好地管理产品与客户的关系，提高客户服务质量
- **操作便捷**：点击选择方式，操作简单直观
- **数据完整**：完整的客户信息展示，便于业务决策
- **可扩展性**：为后续的客户专属产品、定价策略等功能奠定基础 