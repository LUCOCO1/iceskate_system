# 出库单号自动生成功能说明

## 功能概述
已成功实现出库单号的自动生成功能，格式为：当天日期 + 3位序号
- 格式示例：`20250626001`、`20250626002`、`20250626003`

## 实现方式

### 1. 模型修改 (`inventory/models.py`)
- 将 `ProductOutbound` 模型的 `outbound_number` 字段设置为可为空 (`blank=True`)
- 添加了 `generate_outbound_number()` 方法来生成出库单号
- 重写了 `save()` 方法，在创建新记录时自动生成出库单号

#### 关键代码逻辑：
```python
def generate_outbound_number(self):
    """生成出库单号：日期+序号（如：20250626001）"""
    today = timezone.now().date()
    date_str = today.strftime('%Y%m%d')
    
    # 查询当天已有的出库单号，获取最大序号
    existing_numbers = ProductOutbound.objects.filter(
        outbound_date=today,
        outbound_number__startswith=date_str
    ).values_list('outbound_number', flat=True)
    
    max_sequence = 0
    for number in existing_numbers:
        try:
            # 提取序号部分（最后3位）
            sequence = int(number[-3:])
            max_sequence = max(max_sequence, sequence)
        except (ValueError, IndexError):
            continue
    
    # 生成新的序号
    new_sequence = max_sequence + 1
    return f"{date_str}{new_sequence:03d}"

def save(self, *args, **kwargs):
    # 如果是新记录且没有出库单号，则自动生成
    if not self.pk and not self.outbound_number:
        self.outbound_number = self.generate_outbound_number()
    super().save(*args, **kwargs)
```

### 2. 管理界面修改 (`inventory/admin.py`)
- 将 `outbound_number` 字段添加到只读字段列表中
- 在表单中显示出库单号字段，但用户无法编辑
- 添加了字段顺序配置，确保界面布局合理

#### 关键修改：
```python
@admin.register(ProductOutbound)
class ProductOutboundAdmin(admin.ModelAdmin):
    readonly_fields = ['outbound_number', 'created_at', 'created_by']
    fields = ['outbound_number', 'outbound_date', 'order', 'status', 'notes', 'created_at', 'created_by']
```

### 3. 数据库迁移
已创建并应用了数据库迁移文件：
- 迁移名称：`0005_alter_productoutbound_outbound_number`
- 修改了 `outbound_number` 字段允许为空

## 功能特点

1. **自动生成**：创建新出库单时自动生成单号，无需手动输入
2. **日期格式**：使用 YYYYMMDD 格式的日期前缀
3. **序号管理**：每天从001开始，自动递增
4. **唯一性保证**：确保同一天内的出库单号不重复
5. **向后兼容**：现有的出库单号不受影响

## 使用方法

### 在管理后台创建出库单：
1. 进入"库存管理" → "产品出库单"
2. 点击"新增产品出库单"
3. 出库单号字段将显示为只读状态
4. 填写其他必要信息（出库日期、关联订单等）
5. 保存时系统自动生成出库单号

### 通过API创建：
```python
from inventory.models import ProductOutbound

# 创建新出库单
outbound = ProductOutbound()
outbound.outbound_date = timezone.now().date()
outbound.save()  # 保存时会自动生成出库单号

print(outbound.outbound_number)  # 输出如：20250626001
```

## 注意事项

1. 出库单号基于 `outbound_date` 字段生成，而不是创建时间
2. 如果手动设置了出库单号，系统不会重新生成
3. 序号采用3位数格式（001-999），单日最多支持999个出库单
4. 删除出库单后，其序号不会被重复使用

## 优势

- **提高效率**：无需手动输入单号，减少操作步骤
- **避免错误**：自动生成避免了手动输入可能出现的错误
- **统一格式**：确保所有出库单号格式统一
- **易于查找**：通过日期前缀可以快速定位特定日期的出库单 